# 14.1. Optical flow / FlowNet

Image registration 기법.

컴퓨터 비전 분야에서 optical flow 문제를 해결해주기 위한 End to end CNN 구조들이 제안이 되었습니다. 해당 구조의 아이디어를 의료형상 정합에 이용한 방법들을 살펴보자.

의료영상에서는 레이블이 없는 데이터가 많습니다. 레이블이 없이 학습이 가능한 unsupervised learning 기반의 registration 기법에 대해서도 살펴보겠습니다.

# Optical Flow

컴퓨터 비전 분야에서 non-rigid regrestration과 비슷한 문제가 이 옵티컬 플로우 문제임 

옵티컬 플로우는 비디오에서 영상이 있다고 가정 했을때, 프레임 간에 얼마나 차이가 있는지를 추정해주는 것임  

t frame영상과 t + 1 frame 영상이 있을 때. 픽셀 단위로 어떤 점들이 다음 프레임에서 어디로 이동했는지 맞춰주는 문제. 즉, 배경은 바뀔수도 있지만 크게 신경쓰지 않고, 오브젝트 같은 경우 물체의 위치에 따라 어떻게 이동했는지에 해서 맞추는 문제.  

t frame = moving image. t+1 frame = fixed image.

둘 간의 매칭점을 찾고 transformation들을 찾아주면 됨.

similerity에 대한 cost, smooth에 대한 cost 문제 정의를 했는데, 옵티컬 플로우에서도 비슷한 코스트가 보통 정의 됩니다. ***바로 이 코스를 옵티마이제이션 해주는 각 점의 디스플레이스먼트를 찾아아***.

![스크린샷 2025-07-05 21.00.21.png](/assets/의료인공지능/14_1_Optical_flow_FlowNet/image_1.png)

픽셀 단위 t 프레임에서 (x,y)가 이동을 하면 t+1 이미지에서는 x+u만큼 이동했다고 볼 수 있고, y 같은 경우는 v 만큼 이동했다고 생각을 해보면, 이 두 영상 간에 유사도를 구하게 됨.

- 이것이 앞에서 이야기했던 similerity 정의하는 방법

u와 v. 즉, 픽셀에서 x 방향으로 얼만큼 이동했고, y방향으로 얼마만큼 이동했는지 디스플레이스먼트를 구해주는 문제이고, 디스플레이스먼트에 스무스니스텀을 정의 할 수 있음

# FlowNet

![스크린샷 2025-07-05 21.17.00.png](/assets/의료인공지능/14_1_Optical_flow_FlowNet/image_2.png)

t프레임에서의 영상과 t+1프레임 영상을 concatnation시켜 input으로. 만약 RGB라고하면, t에서의 3채널, t+1에서의 3채널. 총 6개의 널을 가진 영상이 들어가게 됨. 

conv→conv→conv→pooling→pooling→.. Refine-ment 단계에서 플로우를 추정함.

- ***refine-ment 부분을 살펴보면 u-net의 구조와 비슷함(다시 사이즈 업) : 작은 사이즈 피처맵을 큰 사이즈 피처맵으로 업 컨볼루션.***
- 이때, 업컨볼루션을 위해서는 transposed conv사용

***위 컨볼루션, 풀링, 업컨볼루션, 다시  concatednation 과정을 반복하여 옵티컬 플로우 맵을 predicted 하게 됨. 여기서 U-net과 다른 점은 작은 사이즈의 이미지에 옵티컬 플로우 맵을 에스티메이션을 하고, 에싀메이션 된 값을 다시 concatnation처리하는 방식을 반복하여 최종적으로 옵티컬 플로우 맵을 에스티메이션함***

여기서 옵티컬 플로우 맵, 프레딕션된 옵티컬 플로우 맵, ground truth 간의 loss를 구함

- 이 loss를 구할 때는 end point error라고 해서 epe Loss를 사용하게 됨.

결국 ground truth와 prediction 간 epe loss를 계산해 backpropagation을 하게 됨

# 다른 방식으로 제안 된 FlowNet

![스크린샷 2025-07-05 22.39.18.png](/assets/의료인공지능/14_1_Optical_flow_FlowNet/image_3.png)

t와 t+1의 concatnation하는 구조 외에도, concatnation을 사용하지 않고, 각각의 패스로 진행시키고 나중에 concation시키는 FlowNet구조도 제안 됨

- 일반적인 concatnation이 아닌 코릴레이션 레이어를 사용함

이후 컨볼루션과 풀링 과정을 거치고, 리파이먼트는 이전과 같이 유넷 구조를 따르게 됨 

원래는 필터를 웨이트로, 파라미터로 설정해서 그 파라미터를 찾아줘 컨볼루션 수행하는 일반 컨볼루션 레이어와 비슷하긴 하나, 코릴레이션 레이어는 피쳐맵에 숫자들을 이용해 컨볼루션을 수행함

이 개념을 더 살펴 보자면..

1x1 필터링을 하여 컨볼루션을 수행하게 되면 하나의 값이 나오게 됨(1x1 외 3x3을 사용해도 무방) 이 과정을 모든 픽셀에 대해서 반복하면, 하나의 값이 나오게 될 것이며, 하나의 채널 결과로 얻어지게 됨

여기에서 디스플레이스먼트만 구해야하는게 목표이며, 트랜스펀던스를 구하기 위해 어떠한 레인지를 정해 필터를 이동시켜줌.

- 해당 범위를 d라고 하면, d 바이 d가 될 것이고 위 논문에서는 21 바이 21로 정의함.
- 모든 디스플레이스먼트 d바이d에 대해서 구하게 되면 뎁스가 d 스퀘어만큼의 어떤 맵을 얻을 수 있음